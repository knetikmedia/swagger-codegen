{{>licenseInfo}}
{{#operations}}

#include "{{classname}}.h"

#include "KnetikCloudClient.h"
#include "KnetikCloudJson.h"

#include <Runtime/Json/Public/Serialization/JsonReader.h>
#include <Runtime/Json/Public/Serialization/JsonSerializer.h>


namespace KnetikCloud
{
	{{classname}}::{{classname}}()
	{
		{{#operation}}
		b{{operationId}}IsComplete = false;
		b{{operationId}}WasSuccessful = false;
		{{#returnType}}
		{{^returnContainer}}
		{{#vendorExtensions.x-codegen-response.isPrimitiveType}}
		{{operationId}}ServerResult = {{vendorExtensions.x-codegen-response.defaultValue}};
		{{/vendorExtensions.x-codegen-response.isPrimitiveType}}
		{{^vendorExtensions.x-codegen-response.isPrimitiveType}}
		{{#vendorExtensions.x-codegen-response.isString}}
		{{operationId}}ServerResult = TEXT("");
		{{/vendorExtensions.x-codegen-response.isString}}
		{{^vendorExtensions.x-codegen-response.isString}}
		{{operationId}}ServerResult = MakeShareable(new {{{returnBaseType}}}());
		{{/vendorExtensions.x-codegen-response.isString}}
		{{/vendorExtensions.x-codegen-response.isPrimitiveType}}
		{{/returnContainer}}
		{{/returnType}}

		{{/operation}}
	}

	{{classname}}::~{{classname}}()
	{
	}

	{{#operation}}
	void {{classname}}::{{operationId}}({{#allParams}}{{{dataType}}} {{paramName}}{{^required}}{{/required}}, {{/allParams}}{{operationId}}CallbackFunction Callback)
	{
		{{#allParams}}
		{{#required}}
		{{^isPrimitiveType}}
		{{^isContainer}}
		if ({{paramName}}.IsValid())
		{
			KnetikCloudLogger::LogError(400, "Missing required parameter '{{paramName}}' when calling {{classname}}->{{operationId}}");
			return;
		}
		
		{{/isContainer}}
		{{/isPrimitiveType}}
		{{/required}}
		{{/allParams}}
		FString Path("{{{path}}}");
		TArray<FString> AuthTypes;
		TMap<FString, FString> QueryParams;
		TMap<FString, FString> FormParams;
		FString JsonBody("");

		{{#pathParams}}
		FString {{{paramName}}}Replacement("{");
		{{{paramName}}}Replacement.Append("{{baseName}}");
		{{{paramName}}}Replacement.Append("}");
		Path = Path.Replace(*{{{paramName}}}Replacement, *KnetikCloudClient::ConvertParameterToContentString({{{paramName}}}));
		{{/pathParams}}
		
		b{{operationId}}IsComplete = false;
		b{{operationId}}WasSuccessful = false;
		{{operationId}}Callback = Callback;

		{{#allParams}}
		{{^isBodyParam}}
		{{^isPathParam}}
		{{#isQueryParam}}
		{{#isString}}
		if ({{paramName}}.Len() > 0)
		{
			QueryParams.Add("{{baseName}}", KnetikCloudClient::ConvertParameterToContentString({{paramName}}));
		}
		{{/isString}}
		{{^isString}}
		{{#isPrimitiveType}}
		QueryParams.Add("{{baseName}}", KnetikCloudClient::ConvertParameterToContentString({{paramName}}));
		{{/isPrimitiveType}}
		{{^isPrimitiveType}}
		if ({{paramName}}.IsValid())
		{
			QueryParams.Add("{{baseName}}", KnetikCloudClient::ConvertParameterToContentString({{paramName}}));
		}
		{{/isPrimitiveType}}
		{{/isString}}

		{{/isQueryParam}}
		{{#isFormParam}}
		{{#isString}}
		if ({{paramName}}.Len() > 0)
		{
			FormParams.Add("{{baseName}}", KnetikCloudClient::ConvertParameterToContentString({{paramName}}));
		}
		{{/isString}}
		{{^isString}}
		{{#isPrimitiveType}}
		FormParams.Add("{{baseName}}", KnetikCloudClient::ConvertParameterToContentString({{paramName}}));
		{{/isPrimitiveType}}
		{{^isPrimitiveType}}
		if ({{paramName}}.IsValid())
		{
			FormParams.Add("{{baseName}}", KnetikCloudClient::ConvertParameterToContentString({{paramName}}));
		}
		{{/isPrimitiveType}}
		{{/isString}}

		{{/isFormParam}}
		{{/isPathParam}}
		{{/isBodyParam}}
		{{/allParams}}
		{{#bodyParam}}
		TSharedPtr<FJsonObject> JsonObject = MakeShareable(new FJsonObject());
		{{#isListContainer}}
		TArray <TSharedPtr<FJsonValue>> JsonValueArray;
		for (auto& Item : {{paramName}})
		{
			TSharedPtr<FJsonValue> ItemJsonValue = KnetikCloudJson::ToJsonValue<{{{vendorExtensions.x-codegen-response.items.dataType}}}>(Item);
			JsonValueArray.Add(ItemJsonValue);
		}
		
		JsonObject->SetArrayField("{{paramName}}", JsonValueArray);
		{{/isListContainer}}
		{{^isListContainer}}
		{{#isString}}
		KnetikCloudJson::AddToJsonObject<{{{baseType}}}>(JsonObject, "{{baseName}}", {{paramName}});
		{{/isString}}
		{{^isString}}
		{{#isPrimitiveType}}
		KnetikCloudJson::AddToJsonObject<{{{baseType}}}>(JsonObject, "{{baseName}}", {{paramName}});
		{{/isPrimitiveType}}
		{{^isPrimitiveType}}
		if ({{paramName}}.IsValid())
		{
			KnetikCloudJson::AddObjectToJsonObject<{{{baseType}}}>(JsonObject, "{{baseName}}", {{paramName}});
		}

		{{/isPrimitiveType}}
		{{/isString}}
		{{/isListContainer}}
		KnetikCloudJson::ToContentString(JsonObject, JsonBody);

		{{/bodyParam}}
		{{#authMethods}}
		AuthTypes.Add("{{name}}");
		{{/authMethods}}

		// Make the actual request...
		TSharedRef<IHttpRequest> Request = KnetikCloudClient::DefaultClient->CreateRequest();
		Request->OnProcessRequestComplete().BindRaw(this, &{{classname}}::{{operationId}}OnResponseReceived);
		KnetikCloudLogger::LogInfo("{{operationId}}: Sending server request...");
		KnetikCloudClient::DefaultClient->CallApi(
			Path,
			"{{httpMethod}}",
			AuthTypes,
			QueryParams,
			FormParams,
			JsonBody,
			Request);
	}

	bool {{classname}}::{{operationId}}IsComplete() const
	{
		return b{{operationId}}IsComplete;
	}

	bool {{classname}}::{{operationId}}WasSuccessful() const
	{
		return b{{operationId}}WasSuccessful;
	}

	void {{classname}}::{{operationId}}OnResponseReceived(FHttpRequestPtr Request, FHttpResponsePtr Response, bool bWasSuccessful)
	{
		b{{operationId}}IsComplete = true;
		b{{operationId}}WasSuccessful = bWasSuccessful;

		if (!Response.IsValid())
		{
			b{{operationId}}WasSuccessful = false;
			KnetikCloudLogger::LogError(0, "{{operationId}}: Unknown error - invalid response!");
		}

		if (Response.IsValid())
		{
			int32 ResponseCode = Response->GetResponseCode();
			if (ResponseCode != KnetikCloud::KnetikCloudConstants::HttpSuccessfulStatusCode)
			{
				b{{operationId}}WasSuccessful = false;
				KnetikCloudLogger::LogError(ResponseCode, "{{operationId}}: Error response received!");
			}
		}

		if (!b{{operationId}}WasSuccessful)
		{
			KnetikCloudLogger::LogError(0, "{{operationId}}: was unsuccessful!");
		}

		{{#returnType}}
		if (Response.IsValid())
		{
			FString ContentString = Response->GetContentAsString();
			KnetikCloudLogger::LogInfo("{{operationId}} content string: " + ContentString);

			{{#isListContainer}}
			// ghornmoen TODO: LIST TEST THIS - is it an array, or is it contained by a parent object?
			TSharedRef<TJsonReader<>> JsonReader = TJsonReaderFactory<>::Create(ContentString);
			TArray<TSharedPtr<FJsonValue>> JsonValueArray;
			if (FJsonSerializer::Deserialize(JsonReader, JsonValueArray))
			{
				for (auto& ItemJsonValue : JsonValueArray)
				{
					if (ItemJsonValue.IsValid())
					{
						{{#items.isPrimitiveType}}
						{{{vendorExtensions.x-codegen-response.items.datatype}}} CurrentItem = KnetikCloudJson::FromJsonValue<{{{vendorExtensions.x-codegen-response.baseType}}}>(ItemJsonValue);
						{{/items.isPrimitiveType}}
						{{^items.isPrimitiveType}}
						{{#items.isString}}
						{{{vendorExtensions.x-codegen-response.items.datatype}}} CurrentItem = KnetikCloudJson::FromJsonValue<{{{vendorExtensions.x-codegen-response.baseType}}}>(ItemJsonValue);
						{{/items.isString}}
						{{^items.isString}}
						{{{vendorExtensions.x-codegen-response.items.datatype}}} CurrentItem = KnetikCloudJson::ObjectFromJsonValue<{{{vendorExtensions.x-codegen-response.baseType}}}>(ItemJsonValue);
						{{/items.isString}}
						{{/items.isPrimitiveType}}
						{{operationId}}ServerResult.Add(CurrentItem);
					}
					else
					{
						b{{operationId}}WasSuccessful = false;
						KnetikCloudLogger::LogInfo("{{operationId}}: Unable to parse the content string: " + ContentString);
						break;
					}
				}
			}
			{{/isListContainer}}
			{{^isListContainer}}
			{{#isMapContainer}}
			TSharedPtr<FJsonObject> JsonObject;
			if (KnetikCloudJson::FromContentString(ContentString, JsonObject))
			{
				for (auto& KeyValuePair : JsonObject->Values)
				{
					{{#items.isPrimitiveType}}
					{{{vendorExtensions.x-codegen-response.items.datatype}}} CurrentItem = KnetikCloudJson::FromJsonValue<{{{vendorExtensions.x-codegen-response.baseType}}}>(KeyValuePair.Value);
					{{/items.isPrimitiveType}}
					{{^items.isPrimitiveType}}
					{{#items.isString}}
					{{{vendorExtensions.x-codegen-response.items.datatype}}} CurrentItem = KnetikCloudJson::FromJsonValue<{{{vendorExtensions.x-codegen-response.baseType}}}>(KeyValuePair.Value);
					{{/items.isString}}
					{{^items.isString}}
					{{{vendorExtensions.x-codegen-response.items.datatype}}} CurrentItem = KnetikCloudJson::ObjectFromJsonValue<{{{vendorExtensions.x-codegen-response.items.datatype}}}>(KeyValuePair.Value);
					{{/items.isString}}
					{{/items.isPrimitiveType}}
					{{operationId}}ServerResult.Add(CurrentItem);
				}
			}
			{{/isMapContainer}}
			{{^isMapContainer}}
			{{#returnTypeIsPrimitive}}
			// ghornmoen TODO: PRIMITIVE TEST THIS - is it a primitive, or is it contained by a parent object?
			TSharedRef<TJsonReader<>> JsonReader = TJsonReaderFactory<>::Create(ContentString);
			TSharedPtr<FJsonValue> JsonValue;
			if (FJsonSerializer::Deserialize(JsonReader, JsonValue))
			{
				if (JsonValue.IsValid())
				{
					{{operationId}}ServerResult = KnetikCloudJson::FromJsonValue<{{{vendorExtensions.x-codegen-response.baseType}}}>(JsonValue);
				}
				else
				{
					b{{operationId}}WasSuccessful = false;
					KnetikCloudLogger::LogInfo("{{operationId}}: Unable to parse the content string: " + ContentString);
				}
			}
			{{/returnTypeIsPrimitive}}
			{{^returnTypeIsPrimitive}}
			{{#vendorExtensions.x-codegen-response.isString}}
			TSharedRef<TJsonReader<>> JsonReader = TJsonReaderFactory<>::Create(ContentString);
			// ghornmoen TODO: STRING TEST THIS - is it a string, or is it contained by a parent object?
			TSharedPtr<FJsonValue> JsonValue;
			if (FJsonSerializer::Deserialize(JsonReader, JsonValue))
			{
				if (JsonValue.IsValid())
				{
					{{operationId}}ServerResult = KnetikCloudJson::FromJsonValue<{{{vendorExtensions.x-codegen-response.baseType}}}>(JsonValue);
				}
				else
				{
					b{{operationId}}WasSuccessful = false;
					KnetikCloudLogger::LogInfo("{{operationId}}: Unable to parse the content string: " + ContentString);
				}
			}
			{{/vendorExtensions.x-codegen-response.isString}}
			{{^vendorExtensions.x-codegen-response.isString}}
			// ghornmoen TODO: OBJECT FAIRLY CERTAIN THIS WAS TESTED BY AuthTypes
			TSharedPtr<FJsonObject> JsonObject;
			if (KnetikCloudJson::FromContentString(ContentString, JsonObject))
			{
				if (JsonObject.IsValid())
				{
					 {{operationId}}ServerResult = KnetikCloudJson::ObjectFromJsonObject<{{{vendorExtensions.x-codegen-response.baseType}}}>(JsonObject);
				}
				else
				{
					b{{operationId}}WasSuccessful = false;
					KnetikCloudLogger::LogInfo("{{operationId}}: Unable to parse the content string: " + ContentString);
				}
			}
			{{/vendorExtensions.x-codegen-response.isString}}
			{{/returnTypeIsPrimitive}}
			{{/isMapContainer}}
			{{/isListContainer}}

			if (b{{operationId}}WasSuccessful)
			{
				KnetikCloudLogger::LogInfo("{{operationId}}: Received response successfully.");
			}
		}
		{{/returnType}}

		{{#returnType}}
		{{#returnContainer}}
		{{operationId}}Callback(b{{operationId}}WasSuccessful, {{operationId}}ServerResult);
		{{/returnContainer}}
		{{^returnContainer}}
		{{operationId}}Callback(b{{operationId}}WasSuccessful, {{operationId}}ServerResult);
		{{/returnContainer}}
		{{/returnType}}
		{{^returnType}}
		{{operationId}}Callback(b{{operationId}}WasSuccessful);
		{{/returnType}}
	}

	{{/operation}}
}
{{/operations}}
