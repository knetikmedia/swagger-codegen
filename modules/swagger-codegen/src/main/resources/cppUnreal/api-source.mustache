{{>licenseInfo}}
{{#operations}}

#include "{{classFilename}}.h"

#include "KnetikCloudClient.h"
#include "KnetikCloudJson.h"

#include <Runtime/Json/Public/Serialization/JsonReader.h>
#include <Runtime/Json/Public/Serialization/JsonSerializer.h>

#if defined(KNETIK_CLOUD_DEBUG)
#pragma optimize("", off)
#endif // KNETIK_CLOUD_DEBUG

{{classname}}::{{classname}}()
{
	{{#operation}}
	b{{operationIdCamelCase}}IsComplete = false;
	b{{operationIdCamelCase}}WasSuccessful = false;
	{{#returnType}}
	{{#returnContainer}}
	{{#isMapContainer}}
	{{operationIdCamelCase}}ServerResponse = NewObject<UKnetikCloudStringMap>();
	{{/isMapContainer}}
	{{/returnContainer}}
	{{^returnContainer}}
	{{#vendorExtensions.x-codegen-response.isPrimitiveType}}
	{{operationIdCamelCase}}ServerResponse = {{vendorExtensions.x-codegen-response.defaultValue}};
	{{/vendorExtensions.x-codegen-response.isPrimitiveType}}
	{{^vendorExtensions.x-codegen-response.isPrimitiveType}}
	{{#vendorExtensions.x-codegen-response.isString}}
	{{operationIdCamelCase}}ServerResponse = TEXT("");
	{{/vendorExtensions.x-codegen-response.isString}}
	{{^vendorExtensions.x-codegen-response.isString}}
	{{operationIdCamelCase}}ServerResponse = NewObject<{{{returnBaseType}}}>();
	{{/vendorExtensions.x-codegen-response.isString}}
	{{/vendorExtensions.x-codegen-response.isPrimitiveType}}
	{{/returnContainer}}
	{{/returnType}}
	{{/operation}}
}

{{classname}}::~{{classname}}()
{
}
{{#operation}}

void {{classname}}::Set{{operationIdCamelCase}}Callback({{operationIdCamelCase}}CallbackFunction Callback)
{
	{{operationIdCamelCase}}Callback = Callback;
}

void {{classname}}::Remove{{operationIdCamelCase}}Callback()
{
	{{operationIdCamelCase}}Callback = nullptr;
}

void {{classname}}::{{operationIdCamelCase}}({{#allParams}}{{#isContainer}}const {{{dataType}}}& {{paramName}}{{/isContainer}}{{^isContainer}}{{#isString}}const FString& {{paramName}}{{/isString}}{{^isString}}{{#isPrimitiveType}}{{{dataType}}} {{paramName}}{{/isPrimitiveType}}{{^isPrimitiveType}}const {{{dataType}}} {{paramName}}{{/isPrimitiveType}}{{/isString}}{{/isContainer}}{{#hasMore}}, {{/hasMore}}{{/allParams}})
{
	{{#allParams}}
	{{#required}}
	{{^isPrimitiveType}}
	{{^isContainer}}
	if ({{paramName}} == nullptr)
	{
		KnetikCloudLogger::LogError(KnetikCloudConstants::HttpGenericErrorCode, "Missing required parameter '{{paramName}}' when calling {{classname}}->{{operationIdCamelCase}}");
		return;
	}
	
	{{/isContainer}}
	{{/isPrimitiveType}}
	{{/required}}
	{{/allParams}}
	FString Path("{{{path}}}");
	TArray<FString> AuthTypes;
	TMap<FString, FString> QueryParams;
	TMap<FString, FString> FormParams;
	FString JsonBody("");

	{{#pathParams}}
	FString {{{paramName}}}Replacement("{");
	{{{paramName}}}Replacement.Append("{{baseName}}");
	{{{paramName}}}Replacement.Append("}");
	Path = Path.Replace(*{{{paramName}}}Replacement, *KnetikCloudJson::ToContentString({{{paramName}}}));
	{{/pathParams}}

	b{{operationIdCamelCase}}IsComplete = false;
	b{{operationIdCamelCase}}WasSuccessful = false;

	{{#allParams}}
	{{^isBodyParam}}
	{{^isPathParam}}
	{{#isQueryParam}}
	{{#isString}}
	if ({{paramName}}.Len() > 0)
	{
		QueryParams.Add("{{baseName}}", KnetikCloudJson::ToContentString({{paramName}}));
	}
	{{/isString}}
	{{^isString}}
	{{#isPrimitiveType}}
	QueryParams.Add("{{baseName}}", KnetikCloudJson::ToContentString({{paramName}}));
	{{/isPrimitiveType}}
	{{^isPrimitiveType}}
	if ({{paramName}} != nullptr)
	{
		QueryParams.Add("{{baseName}}", KnetikCloudJson::ToContentString({{paramName}}));
	}
	{{/isPrimitiveType}}
	{{/isString}}

	{{/isQueryParam}}
	{{#isFormParam}}
	{{#isString}}
	if ({{paramName}}.Len() > 0)
	{
		FormParams.Add("{{baseName}}", KnetikCloudJson::ToContentString({{paramName}}));
	}
	{{/isString}}
	{{^isString}}
	{{#isPrimitiveType}}
	FormParams.Add("{{baseName}}", KnetikCloudJson::ToContentString({{paramName}}));
	{{/isPrimitiveType}}
	{{^isPrimitiveType}}
	if ({{paramName}} != nullptr)
	{
		FormParams.Add("{{baseName}}", KnetikCloudJson::ToContentString({{paramName}}));
	}
	{{/isPrimitiveType}}
	{{/isString}}

	{{/isFormParam}}
	{{/isPathParam}}
	{{/isBodyParam}}
	{{/allParams}}
	{{#bodyParam}}
	TSharedPtr<FJsonObject> JsonObject = MakeShareable(new FJsonObject());
	{{#isListContainer}}
	TArray <TSharedPtr<FJsonValue>> JsonValueArray;
	for (auto& CurrentItem : {{paramName}})
	{
		TSharedPtr<FJsonValue> ItemJsonValue = KnetikCloudJson::ToJsonValue<>(CurrentItem);
		JsonValueArray.Add(ItemJsonValue);
	}
	
	JsonObject->SetArrayField("{{paramName}}", JsonValueArray);
	{{/isListContainer}}
	{{^isListContainer}}
	KnetikCloudJson::AddToJsonObject<{{{baseType}}}>(JsonObject, "{{baseName}}", {{paramName}});
	{{/isListContainer}}
	JsonBody = KnetikCloudJson::ToContentString(JsonObject);

	{{/bodyParam}}
	{{#authMethods}}
	AuthTypes.Add("{{nameInCamelCase}}");
	{{/authMethods}}
	KnetikCloudLogger::LogInfo("getOAuthToken: Sending server request...");
	TSharedRef<IHttpRequest> HttpRequest = UKnetikCloudClient::CreateRequest(
		Path,
		"{{httpMethod}}",
		AuthTypes,
		QueryParams,
		FormParams,
		JsonBody);
	HttpRequest->OnProcessRequestComplete().BindUObject(this, &{{classname}}::{{operationIdCamelCase}}OnResponseReceived);
	HttpRequest->ProcessRequest();
}

void {{classname}}::{{operationIdCamelCase}}OnResponseReceived(FHttpRequestPtr Request, FHttpResponsePtr Response, bool bWasSuccessful)
{
	b{{operationIdCamelCase}}IsComplete = true;
	b{{operationIdCamelCase}}WasSuccessful = bWasSuccessful;

	if (Response.IsValid())
	{
		int32 ResponseCode = Response->GetResponseCode();
		if (ResponseCode == KnetikCloudConstants::HttpSuccessfulStatusCode)
		{
			{{#returnType}}
			FString ContentString = Response->GetContentAsString();
#if defined(KNETIK_CLOUD_DEBUG)
			KnetikCloudLogger::LogInfo("{{operationIdCamelCase}} content string: " + ContentString);
#endif // KNETIK_CLOUD_DEBUG

			{{#isListContainer}}
			TSharedRef<TJsonReader<>> JsonReader = TJsonReaderFactory<>::Create(ContentString);
			TArray<TSharedPtr<FJsonValue>> JsonValueArray;
			if (FJsonSerializer::Deserialize(JsonReader, JsonValueArray))
			{
				for (auto& ItemJsonValue : JsonValueArray)
				{
					if (ItemJsonValue.IsValid())
					{
						{{#vendorExtensions.x-codegen-response.items.isString}}
						FString CurrentItem;
						KnetikCloudJson::FromJsonValue<{{{vendorExtensions.x-codegen-response.items.baseType}}}>(ItemJsonValue, CurrentItem);
						{{/vendorExtensions.x-codegen-response.items.isString}}
						{{^vendorExtensions.x-codegen-response.items.isString}}
						{{#vendorExtensions.x-codegen-response.items.isPrimitiveType}}
						{{{vendorExtensions.x-codegen-response.items.datatype}}} CurrentItem;
						KnetikCloudJson::FromJsonValue<{{{vendorExtensions.x-codegen-response.items.baseType}}}>(ItemJsonValue, CurrentItem);
						{{/vendorExtensions.x-codegen-response.items.isPrimitiveType}}
						{{^vendorExtensions.x-codegen-response.items.isPrimitiveType}}
						{{{vendorExtensions.x-codegen-response.items.datatype}}} CurrentItem = KnetikCloudJson::UObjectFromJsonValue<{{{vendorExtensions.x-codegen-response.items.baseType}}}>(ItemJsonValue);
						{{/vendorExtensions.x-codegen-response.items.isPrimitiveType}}
						{{/vendorExtensions.x-codegen-response.items.isString}}
						{{operationIdCamelCase}}ServerResponse.Add(CurrentItem);
					}
					else
					{
						b{{operationIdCamelCase}}WasSuccessful = false;
						KnetikCloudLogger::LogInfo("{{operationIdCamelCase}}: Unable to parse the content string: " + ContentString);
						break;
					}
				}
			}
			else
			{
				b{{operationIdCamelCase}}WasSuccessful = false;
				KnetikCloudLogger::LogInfo("{{operationIdCamelCase}}: Unable to parse the content string: " + ContentString);
			}
			{{/isListContainer}}
			{{^isListContainer}}
			{{#isMapContainer}}
			TSharedPtr<FJsonObject> JsonObject;
			if (KnetikCloudJson::FromContentString(ContentString, JsonObject))
			{
				for (auto& KeyValuePair : JsonObject->Values)
				{
					{{#vendorExtensions.x-codegen-response.items.isString}}
					FString CurrentItem;
					KnetikCloudJson::FromJsonValue<{{{vendorExtensions.x-codegen-response.items.baseType}}}>(KeyValuePair.Value, CurrentItem);
					{{/vendorExtensions.x-codegen-response.items.isString}}
					{{^vendorExtensions.x-codegen-response.items.isString}}
					{{#vendorExtensions.x-codegen-response.items.isPrimitiveType}}
					{{{vendorExtensions.x-codegen-response.items.datatype}}} CurrentItem;
					KnetikCloudJson::FromJsonValue<{{{vendorExtensions.x-codegen-response.items.baseType}}}>(KeyValuePair.Value, CurrentItem);
					{{/vendorExtensions.x-codegen-response.items.isPrimitiveType}}
					{{^vendorExtensions.x-codegen-response.items.isPrimitiveType}}
					{{{vendorExtensions.x-codegen-response.items.datatype}}} CurrentItem = KnetikCloudJson::UObjectFromJsonValue<{{{vendorExtensions.x-codegen-response.items.baseType}}}>(KeyValuePair.Value);
					{{/vendorExtensions.x-codegen-response.items.isPrimitiveType}}
					{{/vendorExtensions.x-codegen-response.items.isString}}
					{{operationIdCamelCase}}ServerResponse->StringMap.Add(KeyValuePair.Key, CurrentItem);
				}
			}
			else
			{
				b{{operationIdCamelCase}}WasSuccessful = false;
				KnetikCloudLogger::LogInfo("{{operationIdCamelCase}}: Unable to parse the content string: " + ContentString);
			}
			{{/isMapContainer}}
			{{^isMapContainer}}
			{{#returnTypeIsPrimitive}}
			
			KnetikCloudJson::FromContentString(ContentString, {{operationIdCamelCase}}ServerResponse);
			{{/returnTypeIsPrimitive}}
			{{^returnTypeIsPrimitive}}
			{{#vendorExtensions.x-codegen-response.isString}}
			
			KnetikCloudJson::FromContentString(ContentString, {{operationIdCamelCase}}ServerResponse);
			{{/vendorExtensions.x-codegen-response.isString}}
			{{^vendorExtensions.x-codegen-response.isString}}
			TSharedPtr<FJsonObject> JsonObject;
			if (KnetikCloudJson::FromContentString(ContentString, JsonObject))
			{
				if (JsonObject.IsValid())
				{
					{{operationIdCamelCase}}ServerResponse = KnetikCloudJson::UObjectFromJsonObject<{{{vendorExtensions.x-codegen-response.baseType}}}>(JsonObject);
				}
				else
				{
					b{{operationIdCamelCase}}WasSuccessful = false;
					KnetikCloudLogger::LogInfo("{{operationIdCamelCase}}: Unable to parse the content string: " + ContentString);
				}
			}
			{{/vendorExtensions.x-codegen-response.isString}}
			{{/returnTypeIsPrimitive}}
			{{/isMapContainer}}
			{{/isListContainer}}

			if (b{{operationIdCamelCase}}WasSuccessful)
			{
				KnetikCloudLogger::LogInfo("{{operationIdCamelCase}}: Received response successfully.");
			}
			{{/returnType}}
		}
		else
		{
			b{{operationIdCamelCase}}WasSuccessful = false;
			KnetikCloudLogger::LogError(ResponseCode, "{{operationIdCamelCase}}: Error response received!");
		}
	}
	else
	{
		b{{operationIdCamelCase}}WasSuccessful = false;
		KnetikCloudLogger::LogError(KnetikCloudConstants::GenericErrorCode, "{{operationIdCamelCase}}: Unknown error - invalid response!");
	}

	{{#returnType}}
	if ({{operationIdCamelCase}}Callback != nullptr)
	{
		{{operationIdCamelCase}}Callback(bWasSuccessful, {{operationIdCamelCase}}ServerResponse);
	}

	On{{operationIdCamelCase}}.Broadcast(bWasSuccessful, {{operationIdCamelCase}}ServerResponse);
	{{/returnType}}
	{{^returnType}}
	if ({{operationIdCamelCase}}Callback != nullptr)
	{
		{{operationIdCamelCase}}Callback(bWasSuccessful);
	}

	On{{operationIdCamelCase}}.Broadcast(bWasSuccessful);
	{{/returnType}}
}
{{/operation}}
{{/operations}}
